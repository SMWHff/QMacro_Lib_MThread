[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=f5081328-0680-4e92-ad64-3fa092e5fc8c
Description=【神梦_多线程】表格控件实例_保证显示选中项（多线程信号量）
Enable=0
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=Form1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
UEsDBBQAAgAIAASeO1PQKQ12sQUAAAg4AAAJABEAVUlQYWNrYWdlVVQNAAciIFJhIiBSYSIgUmHtW91PXEUUP5ePlm9YCgulFLcoLaXVLi3Q1ha11FYbsZqCPphosgUqxO3SLBCr4cE/wAdffPJJfTHRxKLYpsR+vGBsSgSjUtI0sSYan4yJD9WYFPzN/WBnEdJ7ZgZuSTmbw3AvO/ObOTPn814yyaGpydDtD0eqfqEF9ARl0uxcLq2T7lku21RClOFez87NzXm359ZoVdFdcJa7h2Kvs8HrwbngHHAeuBCcDy4AFzlbT8XgEHgDuBRcBg6Dy8EV4I3gSnCVO/bsmqjvSzpB/fgMUoSOUAJtkt4iDoVxYryxrHt893brex+9/+UNKxO/v1Ps3HuJjlGU1CmHLMvDr7gHrtfKfztMndSuMYM8WEAPP1sBvxPyPkM9dJxidBotl0opw15/yLW9fvtlua2nm/cDP4L51K3QnNbIoaP9ydMa6keif6NGf4v0SLe/Lo2em/hNZ/0MlV2W/qp2J2X/MtJiPr975tlK4XVidJLiinMogv3Ld+MUv/gZkv17mfpoAKw6gxKF9WdK+CeAGqNuegFyiDN9r2f/C9wx/eJnSfidwD8Lv6+x/xZ3/dnS/h9G9BEHJxVnUqaAv05afwq/DfvQRW/w8e14uZgh//UL9r9LU/4iPs9h4OeQE8PL9CqU4g6tPsoMGP/O4jK33dLzHZGOWGIg0tGT7Du1TPh1n76m1f8VWJ4k7E8PfqqQsL/lrk75PX+50vlvh+7xtS79/Je44/nFz1tU/zswj17IgecNK6H/Xg7sFz9fwj+E6P+M7QOS4ATmwPNCYaw/l5y83C9+gYR/FGtP6Nkftv8T9urg/Prj8L6vYw5C7gkV+8/GL0rb/xjkP4g5CDm02fvgeYLU2Via6iH/MKXqXn7wiyX8Nnt8R//84C1y/qwyJn6JhK9rP3TjT116JtnXrdv/Qc5fOnHyB+3YV+X02faHrX8h6fy9CPyzQI8jClehIgX80gX4Iv4awrpVqjCVCvhyvdypP6mfwDyyLJHPiBEeWuI7y11/qmfanw2S/IPIP4W9NJl/RtBWk3//W05G809rC9qtDPwwmc0/N5FT6/eLX0Fm889tzPOXrn8rn39WktH80xLPWB5myH+jhK9Luu4/2537cRix3xX6B+0/V3v+aaL+UIt2M+P8VVGq/mAg/2Tb/01kNv+sc3XKL341Gc0/LfHcpIGBv5nM5p81aLcz8Gso2PxTxEle/nkEZ09EwKoxQKkCfkRaf4e99yu7/i0SftD2s1uzfx6Ffvhu8sJP18fGh/dFhxvxiYZGz125efnXkX/n7xRO/z358/CeZvuqsXD0r4vTqasvrn39eerq+7E/b6auxm9dm5i/Kv3x+tTUpX/OfzvcGHUGbim8MTrx2XBTswtzZWb6m3lQX/MPWv7i+f+bthUaUtJDlfNf+z/7NwSrdwzowvrx8sCwG39FGfZHxBsfzNsfJ//sVpRENfAfQ7uDgb81zf55+ClJJBizqAX+o8SLf7dJ+E8D+xTwRAYep2fRimpcL2f97P2vX3T9XvzNq0PUKOBvXxS/jZ5TqIFUQf670O5k7H9Dmv3vsf1OF3vlDqnUH3ZI+JGA7c/MzIxW/4averX661Yv22Mne+K6/TUKkLr+w0D9mX3+dpJs/0X9a7fy/OX3r5qW+M5KvH/1FEP/hb326k9B1L+Ev/Le6zVR/3oc7X7G+neR2frXAfsc+8ePktn6VzPa3Qz8Rgr2/Qsx1zJD9kOXLo2PXBZR88QnF29d/ePC+at3Px7j9A/6+ZWQo3ie+i45NQAuZQQs/yDqn3vI7Ps3LST+X8G//jWR2fdvRC1hLwO/mYKtf7WQ2frXk+6e+sXfS2brXwL3EAN/H5mtf4nxWhn4+ynY+pfw117960F/f0qXgvafuhTE+zcHSI5/HL0bgBbG7GfwvDmo5B8H0/R/CHj9sD599PYK1X9bydzzNyJi48v0H1BLAQIXCxQAAgAIAASeO1PQKQ12sQUAAAg4AAAJAAkAAAAAAAAAAAAAgAAAAABVSVBhY2thZ2VVVAUAByIgUmFQSwUGAAAAAAEAAQBAAAAA6QUAAAAA


[Script]
'#================================================================
'#        【命令库】神梦_多线程例子
'#----------------------------------------------------------------
'#        【作者】：神梦无痕
'#        【ＱＱ】：1042207232
'#        【Ｑ群】：624655641
'#        【更新】：2021-09-27
'#----------------------------------------------------------------
'#  插件说明：解决多线程资源冲突问题
'#----------------------------------------------------------------
'#  神梦工具: http://pan.baidu.com/s/1dESHf8X
'#----------------------------------------------------------------
'#  特别声明：请勿用于非法用途！！（否则后果自负）
'#================================================================



DimEnv 信号句柄, 运行行号

//初始化命令库，使用前必须调用该命令
Call Lib.神梦_多线程._初始化()

信号句柄 = Lib.神梦_多线程.信号量创建(5)

For hh = 0 To Form1.Grid1.RowCount - 1
	运行行号 = hh
	BeginThread 执行任务(运行行号)
	Delay 500 '线程数越多，这里的延迟要设置大一点 
Next
Do
	Delay 1000
Loop Until Lib.神梦_多线程.信号量是否空闲(信号句柄)
MsgBox "运行完毕！", 64+4096, "温馨提示！"


Declare Function SetScrollPos Lib "user32" Alias "SetScrollPos" (ByVal hwnd As Long, ByVal nBar As Long, ByVal nPos As Long, ByVal bRedraw As Boolean) As Long
Declare Function SendMessage Lib "user32" Alias "SendMessageW" (ByVal hwnd As Long, ByVal wMsg As Long, ByVal wParam As Long, lParam As Any) As Long
Sub 保证显示选择项(行数, 列表框句柄, 列表框高度, 初始行高)
	Dim 初始行数, 滑动位置
	初始行数 = 列表框高度\初始行高
    If 行数 > 初始行数 Then 
    	滑动位置 = 初始行高 * (行数 - 初始行数 + 1)
    Else 
    	滑动位置 = 0
    End If
    SetScrollPos 列表框句柄, 1, 滑动位置, True '滑动条滚动到指定位置
    If 行数 > 初始行数 Then SendMessage 列表框句柄, 277, 1, 0'滑动条向下滚一行
End Sub

Sub 执行任务(行数)    //多线程执行任务
    Dim i, 行号, 次数, n
    行号 = 行数'重新赋值新变量，以免被其他线程影响
    Call Lib.神梦_多线程.信号量等待(信号句柄)
    Call 保证显示选择项(行号, Form1.Grid1.Hwnd, Form1.Grid1.Height, Form1.Grid1.GetRowHeight(0))
    Form1.Grid1.SetProgressBarValue 行号, 7, 0
    次数 = 0
    For i = 0 To 4
        If Form1.Grid1.GetCheckBoxValue(行号, i + 2) = 1 Then   '多选框的勾选返回值是1
            次数 = 次数 + 1
        End If
    Next
    If 次数 = 0 Then Goto 停止    '没有勾选任务，则停止运行
    百分比 = 100 / 次数           '计算进度条的进度值
    n = 0
    For i = 0 To 4
        If Form1.Grid1.GetCheckBoxValue(行号, i + 2) = 1 Then   '多选框的勾选返回值是1
            '在这里，执行的是脚本任务。假设执行完后，任务取消！！！
            Delay 200
            n = n + 1
            Form1.Grid1.SetCheckBoxValue 行号, i + 2, False
            Form1.Grid1.SetProgressBarValue 行号, 7, 百分比 * n
            Delay 500
        End If
    Next
    Rem 停止
    Call 停止状态(行号)
End Sub
 
Sub 运行状态(行)
    Form1.Grid1.SetItemText 行, 8, "运行"
    Form1.Grid1.SetItemText 行, 9, "【点击停止】"
End Sub
Sub 停止状态(行)
    Form1.Grid1.SetItemText 行, 8, "已停止"
    Form1.Grid1.SetItemText 行, 9, "【点击启动】"
End Sub
Sub OnThreadExit()
    Call Lib.神梦_多线程.信号量释放(信号句柄)
End Sub
Sub OnScriptExit()
	Call Lib.神梦_多线程.信号量销毁(信号句柄)
End Sub
Event Form1.LoadOver    //表格内容初始化
    Dim i
    For i = 1 To 100
        Form1.Grid1.SetItemText i, 0, "账号" & i
        Form1.Grid1.SetItemFgColor i, 0, "5EAB25"
        Form1.Grid1.SetItemText i, 1, "窗口" & i
        Form1.Grid1.SetItemFgColor i, 2, "3486F8"
        Form1.Grid1.SetItemFgColor i, 3, "5FB7E3"
        Form1.Grid1.SetItemFgColor i, 5, "B5BE10"
        Form1.Grid1.SetItemFgColor i, 6, "BD53A7"
        Form1.Grid1.SetItemFgColor i, 7, "3486F8"
        Form1.Grid1.SetItemText i, 8, "空闲"
        Form1.Grid1.SetItemFgColor i, 8, "0000FF"
        Form1.Grid1.SetItemText i, 9, "【点击启动】"
        Form1.Grid1.SetItemBkColor i, 9, "D88E0A"
        Form1.Grid1.SetItemFgColor i, 9, "FFFFFF"
        Form1.Grid1.SetCheckBoxValue i, 2, True 
        Form1.Grid1.SetCheckBoxValue i, 3, True
        Form1.Grid1.SetCheckBoxValue i, 4, True
        Form1.Grid1.SetCheckBoxValue i, 5, True
        Form1.Grid1.SetCheckBoxValue i, 6, True 
    Next
    Form1.Grid1.SetColumnEditable 8, False
    Form1.Grid1.SetColumnEditable 9, False
    Redim 任务ID(6)
End Event

